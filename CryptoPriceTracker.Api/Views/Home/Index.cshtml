@using CryptoPriceTraker.Core.Models
@using CryptoPriceTraker.Modules.Track.Models
@model PaginatedResult<CryptoAssetResponseDto>

@{
    ViewData["Title"] = "Crypto Prices";
}

<link rel="stylesheet" href="~/css/crypto-prices.css" />

<div class="container">

    <h1>Cryptocurrency Price Tracker</h1>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="updatePricesBtn" class="btn btn-primary">Update Prices</button>
        <div class="form-group d-flex align-items-center mb-0">
            <label for="pageSize" class="mr-2 mb-0">Items per page:</label>
            <select id="pageSize" class="form-control form-control-sm" style="width: auto;">
                <option value="10" @(Model.PageSize == 10 ? "selected" : "")>10</option>
                <option value="25" @(Model.PageSize == 25 ? "selected" : "")>25</option>
                <option value="50" @(Model.PageSize == 50 ? "selected" : "")>50</option>
                <option value="100" @(Model.PageSize == 100 ? "selected" : "")>100</option>
            </select>
        </div>
    </div>

    <div id="statusMessage" class="mb-3"></div>

    <table id="cryptoTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Icon</th>
                <th>Name</th>
                <th>Symbol</th>
                <th>Current Price</th>
                <th>Change (%)</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody id="cryptoTableBody">
            @if (Model != null && Model.Items.Any())
            {
                @foreach (var asset in Model.Items)
                {
                    <tr>
                        <td>
                            @if (!string.IsNullOrEmpty(asset.IconUrl))
                            {
                                <img src="@asset.IconUrl" alt="@asset.Name Icon" style="width: 24px; height: 24px;" />
                            }
                        </td>
                        <td>@asset.Name</td>
                        <td>@asset.Symbol</td>
                        <td>@asset.CurrentPrice.ToString("C")</td>
                        <td>@asset.ChangePercentage.ToString("F2")%</td>
                        <td data-utc-time="@asset.LastUpdated.ToString("o")"></td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">No crypto prices available.</td>
                </tr>
            }
        </tbody>
    </table>

    @{
        var totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
        var current = Model.PageNumber;
        int visibleRange = 2;
    }

    @if (totalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item @(current == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("", new { pageNumber = current - 1, pageSize = Model.PageSize })">&lt;</a>
                </li>

                @if (current > 3)
                {
                    <li class="page-item"><a class="page-link" href="@Url.Action("", new { pageNumber = 1, pageSize = Model.PageSize })">1</a></li>
                    @if (current > 4)
                    {
                        <li class="page-item disabled"><span class="ellipsis">…</span></li>
                    }
                }

                @for (int i = Math.Max(1, current - visibleRange); i <= Math.Min(totalPages, current + visibleRange); i++)
                {
                    <li class="page-item @(i == current ? "active" : "")">
                        <a class="page-link" href="@Url.Action("", new { pageNumber = i, pageSize = Model.PageSize })">@i</a>
                    </li>
                }

                @if (current < totalPages - 2)
                {
                    @if (current < totalPages - 3)
                    {
                        <li class="page-item disabled"><span class="ellipsis">…</span></li>
                    }
                }

                <li class="page-item @(current == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("", new { pageNumber = current + 1, pageSize = Model.PageSize })">&gt;</a>
                </li>
            </ul>
        </nav>
    }

</div>

<script>
    function updateLocalTimes() {
        document.querySelectorAll('#cryptoTableBody td[data-utc-time]').forEach(function (td) {
            var utcTime = td.getAttribute('data-utc-time');
            var date = new Date(utcTime + "Z");
            td.textContent = date.toLocaleString();
        });
    }

    updateLocalTimes();

    document.querySelectorAll('#cryptoTableBody tr').forEach(row => {
        if (row.cells.length > 4) {
            const changeCell = row.cells[4];
            const textContent = changeCell.textContent.trim();

            if (textContent && textContent !== '') {
                let numericValue = textContent.replace('%', '').trim();
                numericValue = numericValue.replace(',', '.');
                const value = parseFloat(numericValue);

                if (!isNaN(value)) {
                    if (value > 0) {
                        changeCell.style.color = '#48bb78';
                        changeCell.innerHTML = '▲ ' + textContent;
                    } else if (value < 0) {
                        changeCell.style.color = '#f56565';
                        changeCell.innerHTML = '▼ ' + textContent;
                    } else {
                        changeCell.style.color = '#a0aec0';
                        changeCell.innerHTML = '━ ' + textContent;
                    }
                    changeCell.style.fontWeight = '600';
                }
            }
        }
    });

    document.getElementById("pageSize").addEventListener("change", function () {
        var selectedPageSize = this.value;
        var currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("pageSize", selectedPageSize);
        currentUrl.searchParams.set("pageNumber", "1");
        window.location.href = currentUrl.toString();
    });

    document.getElementById("updatePricesBtn").addEventListener("click", async () => {
        const statusMessage = document.getElementById("statusMessage");
        statusMessage.innerText = "Updating prices...";

        try {
            const updateResponse = await fetch("/api/crypto/update-prices", {
                method: "POST"
            });

            if (!updateResponse.ok) throw new Error("Failed to update prices.");

            statusMessage.innerText = "Prices updated successfully. Refreshing...";
            window.location.reload();
        } catch (error) {
            console.error("Error:", error);
            statusMessage.innerText = `Error: ${error.message}`;
        }
    });
</script>